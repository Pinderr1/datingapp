// Firestore Security Rules â€” Pinged MVP (aligned with app writes + lastMessage)
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() { return request.auth != null; }
    function isSelf(uid) { return isSignedIn() && request.auth.uid == uid; }
    function inUsers(uids) { return isSignedIn() && (request.auth.uid in uids); }

    function isValidString(s, min, max) {
      return s is string && s.size() >= min && s.size() <= max;
    }
    function isOptionalString(data, key, min, max) {
      return (!data.keys().hasAny([key])) || isValidString(data[key], min, max);
    }
    function isOptionalTimestamp(data, key) {
      return (!data.keys().hasAny([key])) || (data[key] is timestamp);
    }
    function isOptionalUrlList(data, key) {
      return (!data.keys().hasAny([key])) ||
             (data[key] is list && data[key].all(u, u is string && u.size() > 0 && u.size() <= 2048));
    }
    function isOptionalNumberInRange(data, key, min, max) {
      return (!data.keys().hasAny([key])) ||
             ((data[key] is int || data[key] is float) &&
              data[key] >= min &&
              data[key] <= max);
    }
    function isOptionalBool(data, key) {
      return (!data.keys().hasAny([key])) || (data[key] is bool);
    }
    function isOptionalStringList(data, key, itemMin, itemMax) {
      return (!data.keys().hasAny([key])) ||
             (data[key] is list && data[key].all(v, v is string && v.size() >= itemMin && v.size() <= itemMax));
    }
    function isOptionalGeoPoint(data, key) {
      return (!data.keys().hasAny([key])) || (data[key] is latlng);
    }

    function isValidUserData(data) {
      return data.keys().hasOnly([
        'uid',
        'email',
        'displayName',
        'name',
        'photoURL',
        'phoneNumber',
        'providerId',
        'bio',
        'gender',
        'age',
        'photoURLs',
        'location',
        'onboardingComplete',
        'createdAt',
        'updatedAt',
        'avatarOverlay',
        'introClipUrl',
        'genderPref',
        'mood',
        'favoriteGames',
        'promptResponses',
        'personalityTags',
        'badgePrefs',
        'themePreset',
        'geo'
      ]) &&

      isOptionalString(data, 'uid', 1, 128) &&
      isOptionalString(data, 'email', 3, 320) &&
      isOptionalString(data, 'displayName', 0, 40) &&
      isOptionalString(data, 'name', 0, 80) &&
      isOptionalString(data, 'photoURL', 0, 2048) &&
      isOptionalString(data, 'phoneNumber', 7, 20) &&
      isOptionalString(data, 'providerId', 0, 100) &&
      isOptionalString(data, 'bio', 0, 300) &&
      isOptionalString(data, 'gender', 0, 40) &&
      isOptionalNumberInRange(data, 'age', 18, 120) &&
      isOptionalUrlList(data, 'photoURLs') &&
      isOptionalString(data, 'location', 0, 120) &&
      isOptionalBool(data, 'onboardingComplete') &&
      isOptionalTimestamp(data, 'createdAt') &&
      isOptionalTimestamp(data, 'updatedAt') &&

      isOptionalString(data, 'avatarOverlay', 0, 40) &&
      isOptionalString(data, 'introClipUrl', 0, 2048) &&
      isOptionalString(data, 'genderPref', 0, 40) &&
      isOptionalString(data, 'mood', 0, 120) &&
      isOptionalStringList(data, 'favoriteGames', 1, 60) &&
      isOptionalStringList(data, 'promptResponses', 1, 300) &&
      isOptionalString(data, 'personalityTags', 0, 300) &&
      isOptionalStringList(data, 'badgePrefs', 1, 60) &&
      isOptionalString(data, 'themePreset', 0, 40) &&
      isOptionalGeoPoint(data, 'geo');
    }

    function isValidMatchUsers(users) {
      return users is list &&
             users.size() == 2 &&
             users.all(u, u is string) &&
             users[0] != users[1];
    }

    function isValidMessageData(data) {
      return data.keys().hasOnly(['senderId','content','createdAt']) &&
             data.senderId is string &&
             data.senderId == request.auth.uid &&
             isValidString(data.content, 1, 1000) &&
             isOptionalTimestamp(data, 'createdAt');
    }

    function isValidContactMessage(data) {
      return data.keys().hasOnly(['name','email','message','createdAt']) &&
             isValidString(data.name, 1, 80) &&
             isValidString(data.email, 3, 120) &&
             isValidString(data.message, 1, 2000) &&
             isOptionalTimestamp(data, 'createdAt');
    }

    match /users/{uid} {
      allow read: if isSignedIn();
      allow write: if isSelf(uid) &&
                   (request.resource == null || isValidUserData(request.resource.data));
    }

    match /likes/{uid}/{rest=**} {
      allow read, write: if isSelf(uid);
    }

    match /matches/{matchId} {
      allow read, write: if
        (
          resource != null &&
          inUsers(resource.data.users) &&
          (
            request.resource == null ||
            (
              request.resource.data.keys().hasOnly(['users','createdAt','updatedAt','lastMessage']) &&
              request.resource.data.users != null &&
              request.resource.data.users == resource.data.users &&
              isOptionalString(request.resource.data, 'lastMessage', 0, 1000)
            )
          )
        ) ||
        (
          resource == null &&
          request.resource.data.users != null &&
          inUsers(request.resource.data.users) &&
          request.resource.data.keys().hasOnly(['users','createdAt','updatedAt','lastMessage']) &&
          isValidMatchUsers(request.resource.data.users) &&
          isOptionalString(request.resource.data, 'lastMessage', 0, 1000)
        );

      match /messages/{messageId} {
        allow read, write: if inUsers(get(/databases/$(database)/documents/matches/$(matchId)).data.users) &&
                            (request.resource == null || isValidMessageData(request.resource.data));
      }

      match /games/{gameId} {
        allow read, write: if inUsers(get(/databases/$(database)/documents/matches/$(matchId)).data.users);
      }
    }

    match /contactMessages/{messageId} {
      allow create: if isValidContactMessage(request.resource.data);
    }
  }
}
